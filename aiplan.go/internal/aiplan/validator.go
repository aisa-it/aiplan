// ĞŸĞ°ĞºĞµÑ‚ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ñ… Ğ² AIPlan.  Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ñ€Ñ‹ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹, Ñ‚Ğ°ĞºĞ¸Ñ… ĞºĞ°Ğº Ğ¸Ğ¼Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°, Ğ¸Ğ¼Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‡ĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ÑÑ‚Ğ²Ğ°, Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ¸ Ñ‚.Ğ´.  Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºÑƒ go-playground/validator Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¾Ğº. Ğ¢Ğ°ĞºĞ¶Ğµ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ğ² ÑĞµĞ±Ñ Ñ€ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğµ Ğ²Ñ‹Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….  Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ñ€Ñ‹ Ğ´Ğ»Ñ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ².
//
// ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸:
//   - Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ².
//   - ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹.
//   - Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ñ‹Ñ… Ğ²Ñ‹Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….
//   - Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ².
package aiplan

import (
	"regexp"
	"unicode/utf8"

	"github.com/aisa-it/aiplan/aiplan.go/internal/aiplan/utils"
	"github.com/go-playground/validator"
)

type RequestValidator struct {
	validator *validator.Validate
}

func NewRequestValidator() *RequestValidator {
	v := validator.New()
	err := v.RegisterValidation("projectName", projectNameValidator)
	if err != nil {
		return nil
	}

	err = v.RegisterValidation("workspaceName", workspaceNameValidator)
	if err != nil {
		return nil
	}

	err = v.RegisterValidation("identifier", identifierValidator)
	if err != nil {
		return nil
	}

	err = v.RegisterValidation("slug", slugValidator)
	if err != nil {
		return nil
	}

	err = v.RegisterValidation("fullName", userFullNameValidator)
	if err != nil {
		return nil
	}

	err = v.RegisterValidation("username", usernameValidator)
	if err != nil {
		return nil
	}

	err = v.RegisterValidation("statusEmoji", statusEmojiValidator)
	if err != nil {
		return nil
	}
	return &RequestValidator{v}
}

func (rv *RequestValidator) Validate(i interface{}) error {
	if err := rv.validator.Struct(i); err != nil {
		_, ok := err.(validator.ValidationErrors)
		if !ok {
			return nil
		}
		return err
	}
	return nil
}

func projectNameValidator(fl validator.FieldLevel) bool {
	value := fl.Field().String()
	lenStr := utf8.RuneCountInString(value)
	if !isValidLatinCyrillicDigitWithSymbol(value) {
		return false
	}

	return lenStr >= 1 && lenStr <= 100
}

func workspaceNameValidator(fl validator.FieldLevel) bool {
	value := fl.Field().String()
	lenStr := utf8.RuneCountInString(value)
	if !isValidLatinCyrillicDigitWithSymbol(value) {
		return false
	}
	return lenStr >= 3 && lenStr <= 100
}

func identifierValidator(fl validator.FieldLevel) bool {
	value := fl.Field().String()
	lenStr := utf8.RuneCountInString(value)
	if !isValidLatinUpperDigit(value) {
		return false
	}
	return lenStr >= 3 && lenStr <= 15
}

func slugValidator(fl validator.FieldLevel) bool {
	value := fl.Field().String()
	lenStr := utf8.RuneCountInString(value)
	if !isValidLatinLowerDigitHyphen(value) {
		return false
	}
	return lenStr >= 3 && lenStr <= 50
}

func userFullNameValidator(fl validator.FieldLevel) bool {
	value := fl.Field().String()
	lenStr := utf8.RuneCountInString(value)
	if !isValidLatinCyrillicHyphen(value) {
		return false
	}
	return lenStr >= 1 && lenStr <= 100
}

func usernameValidator(fl validator.FieldLevel) bool {
	value := fl.Field().String()
	lenStr := utf8.RuneCountInString(value)
	if !isValidLatinWithSymbols(value) {
		return false
	}
	return lenStr >= 1 && lenStr <= 100
}

func statusEmojiValidator(fl validator.FieldLevel) bool {
	value := fl.Field().String()
	_, ok := utils.ValidStatusEmoji[value]
	return ok
}

// Validate
func isValidLatinCyrillicDigitWithSymbol(str string) bool {
	pt := `^[A-Za-zĞ-Ğ¯Ğ°-ÑÑ‘Ğ0-9 ._\/\-\\!#\$%&'\"\(\)\*\+,\-.:;â„–<=>?@\[\\\]\^_\{\|\}~]+$`
	re := regexp.MustCompile(pt)
	return re.MatchString(str)
}

func isValidLatinUpperDigit(str string) bool {
	pt := `^[A-Z0-9]+$`
	re := regexp.MustCompile(pt)
	return re.MatchString(str)
}

func isValidLatinCyrillicHyphen(str string) bool {
	pt := `^[A-Za-zĞ-Ğ¯Ğ°-ÑÑ‘Ğ-]+$`
	re := regexp.MustCompile(pt)
	return re.MatchString(str)
}

func isValidLatinWithSymbols(str string) bool {
	pt := `^[A-Za-z0-9._\/\-\\]+$`
	re := regexp.MustCompile(pt)
	return re.MatchString(str)
}

func isValidLatinLowerDigitHyphen(str string) bool {
	pt := `^[a-z0-9-]+$`
	re := regexp.MustCompile(pt)
	return re.MatchString(str)
}

var (
	validReactions = map[string]bool{
		"ğŸ‘":  true,
		"ğŸ‘":  true,
		"â¤ï¸": true,
		"ğŸ˜‚":  true,
		"ğŸ˜®":  true,
		"ğŸ¤¡":  true,
		"ğŸ’©":  true,
		"ğŸ¤®":  true,
	}
)
